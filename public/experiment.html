<!DOCTYPE html>
<html>
  <head>
    <title>Mouse-Tracking</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
    <script src="../jsPsych/jspsych.js"></script>
    <script src="../jsPsych/plugins/jspsych-html-keyboard-response.js"></script>
    <script src="../jsPsych/plugins/jspsych-aaron-response.js"></script>
    <link rel="stylesheet" href="aaron.css"></link>
  </head>
  <body>
  </body>
  <script>
    /* create timeline */
    var timeline = [];

    /* define welcome message trial */
    var welcome_block = {
      type: "html-keyboard-response",
      stimulus: "Mouse-Tracking. Press 'f' or 'j' to begin.",
      choices: ['f', 'j']
    };

    /* define instructions trial */
    var instructions = {
      type: "html-keyboard-response",
      stimulus: "<p>In this experiment, a circle will appear in the center " +
          "of the screen.</p><p>If the circle is <strong>blue</strong>, " +
          "press the letter F on the keyboard as fast as you can.</p>" +
          "<p>If the circle is <strong>orange</strong>, press the letter J " +
          "as fast as you can.</p>" +
          "<div style='float: left;'><img src='./img/items/blue.png'></img>" +
          "<p class='small'><strong>Press the F key</strong></p></div>" +
          "<div class='float: right;'><img src='./img/items/orange.png'></img>" +
          "<p class='small'><strong>Press the J key</strong></p></div>" +
          "<p>Press f or j to begin.</p>",
      choices: ['f', 'j']
      // post_trial_gap: 2000
    };

    function saveTrials() {
      let _data = jsPsych.data.getLastTrialData();

      $.ajax({
        type: "POST",
        url: "/experiment-data",
        data: _data.json(),
        contentType: "application/json"
      })
      .done(function() {
        alert('trial finished!');
      })
      .fail(function() {
        alert('DID NOT WORK');
      })
    }

    // Answers
    const 
      SBJ = (new Date().valueOf().toString(36) + Math.random().toString(36).substr(2)),
      LEFT = 'left_label_div', RIGHT = 'right_label_div',
      nLABELS = ['./img/labels/new/1b.png', './img/labels/new/2b.png', './img/labels/new/3b.png', './img/labels/new/4b.png'],
      oLABELS = ['./img/labels/old/1b.png', './img/labels/old/2b.png', './img/labels/old/3b.png', './img/labels/old/4b.png'],
      LEGEND = {'item': 
                  {
                   images: ['1.jpg', '2.jpg', '3.jpg'],
                   old: 1,
                   new: 1
                  },
                 'otherItem':
                  {
                   images: ['3.jpg', '4.jpg', '5.jpg'],
                   old: 3,
                   new: 4
                  }
                };

    /*
      * Takes the correct label index, deletes it from an array, then
      * returns a randomly chosen one to serve as the WRONG label in 
      * a given trial.
      */
    function _getWrongLabelIndex(correctIndex) {
      var x = [0, 1, 2, 3];
      x.splice(correctIndex, 1);
      return _.shuffle(x).pop();
    }

    /*
      * Takes an array, duplicates it to have <instances> many elements,
      * then shuffles it. If it can't be doubled, it will shuffle around
      * then add enough to fill to <instances>.
      * 
      * NOTE: Won't work for odd lengths.
      * NOTE: instances > arr.length
      * 
      */
    function _repeatAndShuffleArray(arr, instances) {
      var timesToRepeat = (instances / arr.length); // instances > arr.length
      var nArr = [];

      if (timesToRepeat >= 2) { // This method wouldn't work for odd numbers
          for (var i=0; i<Math.round(timesToRepeat); i++) {
            arr.map((item) => nArr.push(item));
          }
          return _.shuffle(nArr);

      } else { // 
        return (_.shuffle(arr)).concat((_.shuffle(arr)).slice(0, (instances-arr.length)));
      }
    }

    /* 
    | TYPE | # Trials | CONDITION              | DESCRIPTION     
    |  1   |    20    | YES && NEW / NO && NEW | Answer YES to the NEW label, OLD label must be INCORRECT
    |  2   |    20    | YES && OLD / NO && OLD | Answer YES to the OLD label, NEW label must be INCORRECT

    - Decide Old/New
    - Decide Correct on Left or Right
    - Pick item -> get item image
    - Get [item] correct label
    - Randomly pick item incorrect label
    */
    function makeTrials() {
      let timeline = [],
          trialLength = 40,
          conditions = repeatAndShuffleArray([true, false], trialLength), 
          divs = _repeatAndShuffleArray([true, false], trialLength),
          targets = _repeatAndShuffleArray(ITEMS, trialLength);

      for (var i=0; i<trialLength; i++) {

        var leftLabel, rightLabel, correctDiv, index;

        /* Annoying conditionals to get proper information */
        if (conditions[i]) { // New
          index = (LEGEND[targets[i]].new) - 1; // runs 1-4
          if(divs[i]) { // left == correct
            leftLabel = nLABELS[index];
            rightLabel = nLABELS[_getWrongLabelIndex(index)];
            correctDiv = 'left_label_div';
          } else { // right == correct
            leftLabel = nLABELS[_getWrongLabelIndex(index)];
            rightLabel = nLABELS[index];
            correctDiv = 'right_label_div';
          }
        } else { // Old
          index = (LEGEND[targets[i]].old) - 1; // runs 1-4
          if(divs[i]) { // left == correct
            leftLabel = oLABELS[index];
            rightLabel = oLABELS[_getWrongTrialIndex(index)];
            correctDiv = 'left_label_div';
          } else { // right == correct
            leftLabel = oLABELS[_getWrongTrialIndex(index)];
            rightLabel = oLABELS[index];
            correctDiv = 'right_label_div';
          }
        }

        timeline.push({
          type: 'aaron-response',
          subject: SBJ,
          label_left: leftLabel,
          label_right: rightLabel,
          target_item: _.sample(targets[i].images, 1), // picks a random image
          correct_response: correctDiv,
          on_finish: saveTrials
        });
      }
      return timeline;
    }

 
    var tempItems = ['./img/items/blue.png', './img/items/orange.png'];
    var test1 = 
      {type: 'aaron-response',
       subject: SBJ,
       label_left: nLABELS[0], 
       label_right: oLABELS[1], 
       target_item: tempItems[0],
       correct_response: LEFT,
       on_finish: saveTrials
      };

   var test2 = 
      {type: 'aaron-response',
       subject: SBJ,
       label_left: nLABELS[0], 
       label_right: oLABELS[1], 
       target_item: tempItems[0],
       correct_response: LEFT,
       on_finish: saveTrials
      };


    // var fixation = {
    //   type: 'html-keyboard-response',
    //   stimulus: '<div style="font-size:60px;">+</div>',
    //   choices: jsPsych.NO_KEYS,
    //   trial_duration: function(){
    //     return 250;
    //     // jsPsych.randomization.sampleWithoutReplacement([250, 500, 750, 1000, 1250, 1500, 1750, 2000], 1)[0];
    //   },
    //   data: {test_part: 'fixation'}
    // }

    var debrief_block = {
      type: "html-keyboard-response",
      stimulus: function() {

        var trials = jsPsych.data.get().filter({test_part: 'test'});
        var correct_trials = trials.filter({correct: true});
        var accuracy = Math.round(correct_trials.count() / trials.count() * 100);
        var rt = Math.round(correct_trials.select('rt').mean());

        return "<p>You responded correctly on "+accuracy+"% of the trials.</p>"+
        "<p>Your average response time was "+rt+"ms.</p>"+
        "<p>Press any key to complete the experiment. Thank you!</p>";
      }
    };


    // timeline.push(welcome_block);
    // timeline.push(instructions);
    timeline.push(test1);
    timeline.push(test2);
    timeline.push(debrief_block);

    /* start the experiment */
    jsPsych.init({
      timeline: timeline,
      on_finish: function() { jsPsych.data.displayData(); }
    });
  </script>
</html>
